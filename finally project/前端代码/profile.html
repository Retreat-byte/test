<!DOCTYPE html>
<html lang="zh-CN">
	<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>个人中心 - 情绪岛</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
	</head>
	<body>
    <!-- 顶部导航栏 -->
    <header class="header">
        <div class="container">
            <div class="logo">
                <i class="fas fa-island-tropical"></i>
                <span>情绪岛</span>
                <small>守护心灵的港湾</small>
            </div>
            <nav class="nav">
                <a href="home.html" class="nav-link">
                    <i class="fas fa-home"></i> 首页
                </a>
                <a href="ai-chat.html" class="nav-link">
                    <i class="fas fa-comments"></i> AI对话
                </a>
                <a href="tools.html" class="nav-link">
                    <i class="fas fa-toolbox"></i> 心理工具
                </a>
                <a href="profile.html" class="nav-link active">
                    <i class="fas fa-user"></i> 个人中心
                </a>
            </nav>
            <div class="user-info">
                <button class="btn-login" id="loginBtn">登录</button>
                <div class="user-profile" id="userProfile" style="display: none;">
                    <div class="user-avatar" id="headerAvatar">
                        <i class="fas fa-user-circle"></i>
                    </div>
                    <div class="user-details">
                        <span class="user-nickname" id="headerNickname">用户</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="user-dropdown">
                        <a href="profile.html" class="dropdown-item">
                            <i class="fas fa-user"></i> 个人中心
                        </a>
                        <a href="#" class="dropdown-item" id="headerLogoutBtn">
                            <i class="fas fa-sign-out-alt"></i> 退出登录
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- 主内容区 -->
    <main class="main-content">
        <!-- 个人中心页 -->
        <section id="profile" class="page active">
            <!-- 顶部信息区 -->
            <div class="profile-top">
                <div class="profile-header-new">
                    <div class="profile-info">
                        <div class="profile-avatar">
                            <i class="fas fa-user-circle"></i>
                        </div>
                        <div>
                            <h2>我的情绪岛</h2>
                            <p>情绪岛已陪伴你 <span class="highlight">15</span> 天</p>
                        </div>
                    </div>
                    <button class="btn-settings"><i class="fas fa-cog"></i> 设置</button>
                </div>

                <div class="profile-stats-new">
                    <div class="stat-card-new">
                        <div class="stat-icon blue">
                            <i class="fas fa-calendar-check"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-number">28</div>
                            <div class="stat-label">打卡天数</div>
                        </div>
                    </div>
                    <div class="stat-card-new">
                        <div class="stat-icon purple">
                            <i class="fas fa-dumbbell"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-number">156</div>
                            <div class="stat-label">练习次数</div>
                        </div>
                    </div>
                    <div class="stat-card-new">
                        <div class="stat-icon green">
                            <i class="fas fa-clipboard-check"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-number">8</div>
                            <div class="stat-label">完成测评</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 主内容网格 (左右布局) -->
            <div class="profile-grid">
                <!-- 左侧主要内容 -->
                <div class="profile-main">
                    <!-- 情绪趋势图 -->
                    <div class="emotion-chart-section">
                        <div class="section-header">
                            <h2>情绪趋势</h2>
                            <div class="chart-tabs">
                                <button class="tab-btn active" data-period="week">周视图</button>
                                <button class="tab-btn" data-period="month">月视图</button>
                            </div>
                        </div>
                        <div class="chart-container" style="height: 450px;">
                            <canvas id="emotionChart"></canvas>
                        </div>
                        <div class="emotion-summary">
                            <div class="summary-item">
                                <span class="label">平均心情</span>
                                <span class="value" id="averageMood">---</span>
                            </div>
                            <div class="summary-item">
                                <span class="label">最佳状态</span>
                                <span class="value" id="bestMood">---</span>
                            </div>
                            <div class="summary-item">
                                <span class="label">改善趋势</span>
                                <span class="value" id="trendMood">---</span>
                            </div>
                        </div>
                    </div>

                    <!-- 历史记录 -->
                    <div class="history-section">
                        <h2>历史记录</h2>
                        <div class="history-tabs">
                            <button class="history-tab active" data-type="practice">练习历史</button>
                            <button class="history-tab" data-type="assessment">测评报告</button>
                        </div>
                        
                        <div class="history-content" id="practiceHistory">
                            <div class="history-item">
                                <div class="history-icon blue">
                                    <i class="fas fa-wind"></i>
                                </div>
                                <div class="history-info">
                                    <h3>正念呼吸</h3>
                                    <p>2024-12-17 08:30</p>
                                </div>
                                <div class="history-duration">10分钟</div>
                            </div>
                            <div class="history-item">
                                <div class="history-icon purple">
                                    <i class="fas fa-om"></i>
                                </div>
                                <div class="history-info">
                                    <h3>晨间冥想</h3>
                                    <p>2024-12-16 07:00</p>
                                </div>
                                <div class="history-duration">15分钟</div>
                            </div>
                            <div class="history-item">
                                <div class="history-icon green">
                                    <i class="fas fa-moon"></i>
                                </div>
                                <div class="history-info">
                                    <h3>睡前冥想</h3>
                                    <p>2024-12-15 22:30</p>
                                </div>
                                <div class="history-duration">20分钟</div>
                            </div>
                            <div class="history-item">
                                <div class="history-icon blue">
                                    <i class="fas fa-wind"></i>
                                </div>
                                <div class="history-info">
                                    <h3>正念呼吸</h3>
                                    <p>2024-12-14 19:00</p>
                                </div>
                                <div class="history-duration">8分钟</div>
                            </div>
                            <div class="history-item">
                                <div class="history-icon purple">
                                    <i class="fas fa-om"></i>
                                </div>
                                <div class="history-info">
                                    <h3>森林冥想</h3>
                                    <p>2024-12-13 14:30</p>
                                </div>
                                <div class="history-duration">10分钟</div>
                            </div>
                        </div>
                        
                        <div class="history-content" id="assessmentHistory" style="display: none;">
                            <div class="history-item">
                                <div class="history-icon pink">
                                    <i class="fas fa-file-alt"></i>
                                </div>
                                <div class="history-info">
                                    <h3>抑郁症筛查量表</h3>
                                    <p>2024-12-10 14:20</p>
                                </div>
                                <button class="btn-view" type="button" data-report-type="sds" data-report-date="2024-12-10 14:20">查看报告</button>
                            </div>
                            <div class="history-item">
                                <div class="history-icon pink">
                                    <i class="fas fa-file-alt"></i>
                                </div>
                                <div class="history-info">
                                    <h3>焦虑症筛查量表</h3>
                                    <p>2024-12-05 10:15</p>
                                </div>
                                <button class="btn-view" type="button" data-report-type="sas" data-report-date="2024-12-05 10:15">查看报告</button>
                            </div>
                            <div class="history-item">
                                <div class="history-icon pink">
                                    <i class="fas fa-file-alt"></i>
                                </div>
                                <div class="history-info">
                                    <h3>压力感知量表</h3>
                                    <p>2024-11-28 16:45</p>
                                </div>
                                <button class="btn-view" type="button" data-report-type="stress" data-report-date="2024-11-28 16:45">查看报告</button>
                            </div>
                            <div class="history-item">
                                <div class="history-icon pink">
                                    <i class="fas fa-file-alt"></i>
                                </div>
                                <div class="history-info">
                                    <h3>匹兹堡睡眠质量指数</h3>
                                    <p>2024-12-01 09:30</p>
                                </div>
                                <button class="btn-view" type="button" data-report-type="psqi" data-report-date="2024-12-01 09:30">查看报告</button>
                            </div>
                            <div class="history-item">
                                <div class="history-icon pink">
                                    <i class="fas fa-file-alt"></i>
                                </div>
                                <div class="history-info">
                                    <h3>SCL-90 心理健康自评</h3>
                                    <p>2024-11-25 15:00</p>
                                </div>
                                <button class="btn-view" type="button" data-report-type="scl90" data-report-date="2024-11-25 15:00">查看报告</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 右侧次要内容 -->
                <div class="profile-sidebar">
                    <!-- 成就勋章 -->
                    <div class="achievements-section">
                        <h2>成就勋章</h2>
                        <div class="achievements-grid-sidebar">
                            <div class="achievement-card unlocked">
                                <div class="achievement-icon purple">
                                    <i class="fas fa-heart"></i>
                                </div>
                                <h3>初心者</h3>
                                <p>完成第一次打卡</p>
                                <span class="date">2024-12-01</span>
                            </div>
                            <div class="achievement-card unlocked">
                                <div class="achievement-icon blue">
                                    <i class="fas fa-calendar-check"></i>
                                </div>
                                <h3>坚持者</h3>
                                <p>连续打卡7天</p>
                                <span class="date">2024-12-05</span>
                            </div>
                            <div class="achievement-card unlocked">
                                <div class="achievement-icon green">
                                    <i class="fas fa-wind"></i>
                                </div>
                                <h3>呼吸大师</h3>
                                <p>完成10次呼吸练习</p>
                                <span class="date">2024-12-08</span>
                            </div>
                            <div class="achievement-card unlocked">
                                <div class="achievement-icon purple">
                                    <i class="fas fa-om"></i>
                                </div>
                                <h3>冥想达人</h3>
                                <p>累计冥想60分钟</p>
                                <span class="date">2024-12-10</span>
                            </div>
                            <div class="achievement-card unlocked">
                                <div class="achievement-icon blue">
                                    <i class="fas fa-trophy"></i>
                                </div>
                                <h3>情绪管理师</h3>
                                <p>连续打卡30天</p>
                                <span class="date">2024-12-15</span>
                            </div>
                            <div class="achievement-card unlocked">
                                <div class="achievement-icon green">
                                    <i class="fas fa-star"></i>
                                </div>
                                <h3>心理探索者</h3>
                                <p>完成5项测评</p>
                                <span class="date">2024-12-18</span>
                            </div>
                        </div>
                    </div>

                    <!-- 心理援助热线 -->
                    <div class="hotline-section">
                        <h2>心理援助热线</h2>
                        <div class="hotline-card-large">
                            <i class="fas fa-phone-volume"></i>
                            <h3>24小时专业咨询</h3>
                            <p class="hotline-number-large">010-82951332</p>
                            <p class="hotline-desc">如遇紧急情况，请立即拨打</p>
                            <button class="btn-call">
                                <i class="fas fa-phone-alt"></i> 拨打热线
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- 设置模态框 -->
    <div class="settings-modal" id="settingsModal">
        <div class="settings-backdrop"></div>
        <div class="settings-container">
            <div class="settings-header">
                <h2><i class="fas fa-cog"></i> 个人设置</h2>
                <button class="settings-close" id="closeSettings">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="settings-body">
                <div class="settings-section">
                    <h3>个人信息</h3>
                    <div class="settings-form">
                        <div class="form-group">
                            <label><i class="fas fa-camera"></i> 头像</label>
                            <div class="avatar-upload">
                                <div class="avatar-preview" id="avatarPreview">
                                    <i class="fas fa-user-circle"></i>
                                </div>
                                <div class="avatar-actions">
                                    <input type="file" id="avatarInput" accept="image/*" style="display: none;">
                                    <button type="button" class="btn-upload-avatar" id="uploadAvatarBtn">
                                        <i class="fas fa-upload"></i> 上传头像
                                    </button>
                                    <p class="avatar-tip">支持JPG、PNG格式，最大2MB</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label><i class="fas fa-user"></i> 昵称</label>
                            <input type="text" id="userNickname" placeholder="请输入昵称" value="情绪岛居民">
                        </div>
                        
                        <div class="form-group">
                            <label><i class="fas fa-phone"></i> 手机号</label>
                            <input type="tel" id="userPhone" placeholder="请输入手机号" value="138****8888">
                        </div>
                        
                        <div class="form-group">
                            <label><i class="fas fa-birthday-cake"></i> 生日</label>
                            <input type="date" id="userBirthday" value="1995-06-15">
                        </div>
                        
                        <div class="form-group">
                            <label><i class="fas fa-venus-mars"></i> 性别</label>
                            <div class="radio-group">
                                <label class="radio-label">
                                    <input type="radio" name="gender" value="male">
                                    <span>男</span>
                                </label>
                                <label class="radio-label">
                                    <input type="radio" name="gender" value="female" checked>
                                    <span>女</span>
                                </label>
                                <label class="radio-label">
                                    <input type="radio" name="gender" value="other">
                                    <span>其他</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="settings-footer">
                <button class="btn-save-settings" id="saveSettings">
                    <i class="fas fa-save"></i> 保存设置
                </button>
            </div>
        </div>
    </div>

    <!-- 测评报告模态框 -->
    <div class="report-modal" id="reportModal">
        <div class="report-backdrop"></div>
        <div class="report-container">
            <!-- 报告头部 -->
            <div class="report-header">
                <div class="report-title-section">
                    <div class="report-icon" id="reportIcon">
                        <i class="fas fa-cloud-rain"></i>
                    </div>
                    <div>
                        <h2 id="reportTitle">SDS 抑郁自评量表</h2>
                        <p class="report-subtitle">了解您的抑郁状况，守护心理健康</p>
                    </div>
                </div>
                <button class="report-close" id="closeReport">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- 报告主体内容 -->
            <div class="report-body">
                <!-- 得分卡片 -->
                <div class="report-score-card">
                    <div class="score-icon" id="scoreIcon">
                        <i class="fas fa-cloud-rain"></i>
                    </div>
                    <div class="score-number" id="reportScore">65</div>
                    <div class="score-label" id="reportLevel">中度抑郁</div>
                </div>

                <!-- 结果分析 -->
                <div class="report-result-section">
                    <h3><i class="fas fa-clipboard-check"></i> 结果分析</h3>
                    <div class="result-text" id="resultContent">
                        您目前处于中度抑郁状态。建议找心理专家咨询。主要问题可能包括：经常感到情绪消沉郁闷、要哭或想哭、夜间睡眠不好、体重减轻、便秘、感到心跳加快、感到疲劳、坐卧不安、容易激怒、想到死。建议您积极寻求心理咨询，学习情绪管理技巧，同时保持规律作息，适当运动。
                    </div>
                </div>
                
                <!-- 因子分析（仅多因子量表显示） -->
                <div class="report-factor-section" id="reportFactorSection" style="display: none;">
                    <h3><i class="fas fa-th-list"></i> 因子分析</h3>
                    <div class="factor-grid" id="reportFactorGrid"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 底部浮动AI助手按钮 -->
    <button class="floating-ai-btn" id="floatingAIBtn" title="与AI助手对话" onclick="location.href='ai-chat.html'">
        <i class="fas fa-comments"></i>
        <span class="pulse-ring"></span>
    </button>

    <!-- 引入 Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- 测评报告处理脚本 -->
    <script>
        // 模拟的测评数据库
        const mockReportData = {
            sds: {
                title: 'SDS 抑郁自评量表',
                subtitle: '了解您的抑郁状况，守护心理健康',
                icon: 'fa-cloud-rain',
                score: 65,
                levelText: '中度抑郁',
                result: '您目前处于中度抑郁状态。建议找心理专家咨询。主要问题可能包括：经常感到情绪消沉郁闷、要哭或想哭、夜间睡眠不好、体重减轻、便秘、感到心跳加快、感到疲劳、坐卧不安、容易激怒、想到死。建议您积极寻求心理咨询，学习情绪管理技巧，同时保持规律作息，适当运动。'
            },
            sas: {
                title: 'SAS 焦虑自评量表',
                subtitle: '了解您的焦虑状况，守护心理健康',
                icon: 'fa-heartbeat',
                score: 58,
                levelText: '轻度焦虑',
                result: '您目前处于轻度焦虑状态。建议进行自我调节。主要问题可能包括：感到紧张不安、容易担心、坐立不安、感到疲乏、注意力难以集中、易怒、肌肉紧张、睡眠困难。建议您每天练习深呼吸和正念冥想，减少咖啡因摄入，合理安排工作和休息时间，给自己留出放松的时间。'
            },
            stress: {
                title: 'APESK-PSTR 心理压力量表',
                subtitle: '了解您的压力状况，守护心理健康',
                icon: 'fa-brain',
                score: 72,
                levelText: '中等压力',
                result: '您目前承受着中等程度的心理压力。建议学习压力管理技巧。主要问题可能包括：工作任务较重、时间压力大、人际关系紧张、工作生活失衡、易烦躁焦虑、睡眠质量下降。建议您列出任务清单分清轻重缓急，学习并实践渐进式肌肉放松和冥想，设置明确的工作边界保证休息时间，必要时寻求专业心理咨询。'
            },
            psqi: {
                title: 'PSQI 匹兹堡睡眠质量指数',
                subtitle: '了解您的睡眠质量，守护心理健康',
                icon: 'fa-bed',
                score: 12,
                levelText: '睡眠质量较差',
                result: '您的睡眠质量较差。建议改善睡眠习惯。主要问题可能包括：入睡困难、睡眠时间短、睡眠效率低、白天功能受影响、易醒多梦。建议您每天固定时间上床起床（包括周末），确保卧室安静黑暗凉爽，睡前1小时避免使用电子设备，下午3点后避免咖啡因，睡前3小时避免大量饮食。'
            },
            scl90: {
                title: 'SCL-90 心理健康自评量表',
                subtitle: '了解您的心理健康状况，守护心理健康',
                icon: 'fa-notes-medical',
                score: 185,
                levelText: '轻度症状',
                result: '您的心理健康状况总体尚可，但在某些方面存在轻度症状。主要问题可能包括：偶尔感到身体不适、有时出现强迫性思维、人际交往中较为敏感、存在轻微抑郁情绪、偶尔感到焦虑。建议您注意身体症状可能与心理压力有关，学习放松技巧，尝试更开放的沟通方式，培养兴趣爱好增加积极体验，定期进行心理健康自我评估。'
            }
        };

        // 初始化测评报告功能
        async function initAssessmentReports() {
            // 加载测评历史
            await loadAssessmentHistory();
            
            // 初始化报告模态框
            initReportModal();
        }
        
        /**
         * 加载测评历史记录
         */
        async function loadAssessmentHistory() {
            try {
                const result = await AssessmentAPI.getReportHistory({
                    days: 180,  // 获取最近半年的记录
                    limit: 20   // 最多显示20条
                });
                
                if (result.success && result.data.length > 0) {
                    console.log('✅ 测评历史加载成功:', result.data.length, '条记录');
                    updateAssessmentDisplay(result.data);
                } else {
                    console.log('📊 暂无测评记录');
                }
            } catch (error) {
                console.error('❌ 加载测评历史错误:', error);
            }
        }
        
        /**
         * 更新测评历史显示
         */
        function updateAssessmentDisplay(reports) {
            const container = document.getElementById('assessmentHistory');
            if (!container) return;
            
            // 清空现有内容
            container.innerHTML = '';
            
            reports.forEach(report => {
                const item = document.createElement('div');
                item.className = 'history-item';
                
                const icon = AssessmentAPI.getTypeIcon(report.type);
                const date = new Date(report.timestamp);
                const dateStr = `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')} ${String(date.getHours()).padStart(2,'0')}:${String(date.getMinutes()).padStart(2,'0')}`;
                
                item.innerHTML = `
                    <div class="history-icon pink">
                        <i class="fas ${icon}"></i>
                    </div>
                    <div class="history-info">
                        <h3>${report.name}</h3>
                        <p>${dateStr}</p>
                    </div>
                    <button class="btn-view" type="button" data-report-id="${report.id}">查看报告</button>
                `;
                
                container.appendChild(item);
            });
        }
        
        /**
         * 初始化报告模态框
         */
        function initReportModal() {
            const reportModal = document.getElementById('reportModal');
            const closeBtn = document.getElementById('closeReport');
            
            // 使用事件委托处理查看报告按钮点击
            document.addEventListener('click', async function(e) {
                if (e.target.classList.contains('btn-view') || e.target.closest('.btn-view')) {
                    const btn = e.target.classList.contains('btn-view') ? e.target : e.target.closest('.btn-view');
                    const reportId = btn.dataset.reportId;
                    
                    if (reportId) {
                        await showReportDetail(reportId);
                    }
                }
            });
            
            // 显示报告详情
            async function showReportDetail(reportId) {
                try {
                    const result = await AssessmentAPI.getReportDetail(reportId);
                    
                    if (result.success) {
                        const report = result.data;
                        
                        // 更新标题
                        document.getElementById('reportTitle').textContent = report.name;
                        document.querySelector('.report-subtitle').textContent = '了解您的心理健康状况';
                        
                        // 更新图标
                        const icon = AssessmentAPI.getTypeIcon(report.type);
                        document.getElementById('reportIcon').innerHTML = `<i class="fas ${icon}"></i>`;
                        document.getElementById('scoreIcon').innerHTML = `<i class="fas ${icon}"></i>`;
                        
                        // 更新得分和等级
                        document.getElementById('reportScore').textContent = report.score;
                        document.getElementById('reportLevel').textContent = report.level || '评估结果';
                        
                        // 更新结果分析
                        document.getElementById('resultContent').textContent = report.analysis || '暂无分析';
                        
                        // 显示因子分数（如果有）
                        displayFactorScores(report.factorScores);
                        
                        // 显示模态框
                        reportModal.classList.add('active');
                    } else {
                        alert('报告加载失败: ' + result.message);
                    }
                } catch (error) {
                    console.error('显示报告错误:', error);
                    alert('报告加载失败');
                }
            }
            
            /**
             * 显示因子分数
             */
            function displayFactorScores(factorScores) {
                const factorSection = document.getElementById('reportFactorSection');
                const factorGrid = document.getElementById('reportFactorGrid');
                
                // 如果没有因子分数，隐藏因子分析区域
                if (!factorScores || Object.keys(factorScores).length === 0) {
                    factorSection.style.display = 'none';
                    return;
                }
                
                // 显示因子分析区域
                factorSection.style.display = 'block';
                factorGrid.innerHTML = '';
                
                // 渲染每个因子
                for (const [factorName, score] of Object.entries(factorScores)) {
                    const factorCard = document.createElement('div');
                    factorCard.className = 'factor-card';
                    
                    // 根据分数判断颜色
                    let colorClass = 'normal';
                    if (score >= 3) {
                        colorClass = 'high';
                    } else if (score >= 2) {
                        colorClass = 'medium';
                    }
                    
                    factorCard.innerHTML = `
                        <div class="factor-name">${factorName}</div>
                        <div class="factor-score ${colorClass}">${score.toFixed(2)}</div>
                        <div class="factor-bar">
                            <div class="factor-bar-fill ${colorClass}" style="width: ${(score / 5) * 100}%"></div>
                        </div>
                    `;
                    
                    factorGrid.appendChild(factorCard);
                }
            }
            
            // 关闭模态框
            function closeModal() {
                reportModal.classList.remove('active');
            }
            
            // 事件监听
            closeBtn.addEventListener('click', closeModal);
            
            // 点击背景关闭
            document.querySelector('.report-backdrop').addEventListener('click', closeModal);
        }

        // 页面加载完成后初始化测评报告
        window.addEventListener('load', initAssessmentReports);
    </script>
    
    <!-- 情绪图表专用脚本 -->
    <script>
        // 生成30天模拟数据（10分制，8种心情）
        function generateMockData() {
            const data = [];
            const moods = [
                { name: '悲伤', value: 1 },
                { name: '生气', value: 2 },
                { name: '难过', value: 3 },
                { name: '尴尬', value: 4 },
                { name: '紧张', value: 5 },
                { name: '平静', value: 6 },
                { name: '微笑', value: 8 },
                { name: '开心', value: 10 }
            ];
            
            for (let i = 29; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                // 随机生成心情，偏向中高分段
                const randomIndex = Math.floor(Math.random() * 5) + 3; // 索引3-7，对应紧张到开心
                const randomMood = moods[randomIndex];
                
                data.push({
                    date: dateStr,
                    mood: randomMood.name,
                    value: randomMood.value
                });
            }
            return data;
        }

        // 确保有数据，并检查是否需要升级到新的10分制（8种心情）
        let chartMoodData = [];
        const stored = localStorage.getItem('moodData');
        if (stored) {
            chartMoodData = JSON.parse(stored);
            // 检查是否需要升级：数据少于20条，或者悲伤值不等于1（旧版本悲伤是0）
            const needsUpgrade = chartMoodData.length < 20 || 
                                (chartMoodData.some(d => d.mood === '悲伤' && d.value !== 1));
            if (needsUpgrade) {
                console.log('升级到新版10分制心情数据（8种心情）...');
                chartMoodData = generateMockData();
                localStorage.setItem('moodData', JSON.stringify(chartMoodData));
            }
        } else {
            chartMoodData = generateMockData();
            localStorage.setItem('moodData', JSON.stringify(chartMoodData));
        }

        // 预加载心情图标
        const moodIcons = {
            1: new Image(),
            2: new Image(),
            3: new Image(),
            4: new Image(),
            5: new Image(),
            6: new Image(),
            8: new Image(),
            10: new Image()
        };
        
        moodIcons[1].src = 'img/sorrow.svg';
        moodIcons[2].src = 'img/angry.svg';
        moodIcons[3].src = 'img/sad.svg';
        moodIcons[4].src = 'img/awkward.svg';
        moodIcons[5].src = 'img/nervous.svg';
        moodIcons[6].src = 'img/calm.svg';
        moodIcons[8].src = 'img/smile.svg';
        moodIcons[10].src = 'img/happy.svg';

        // 当页面加载完成后初始化图表
        window.addEventListener('load', function() {
            console.log('开始初始化图表，Chart.js状态:', typeof Chart);
            
            if (typeof Chart === 'undefined') {
                console.error('Chart.js未加载');
                return;
            }

            const canvas = document.getElementById('emotionChart');
            if (!canvas) {
                console.error('找不到canvas元素');
                return;
            }

            let currentChart = null;

            // 自定义插件：在Y轴绘制心情图标
            const moodIconPlugin = {
                id: 'moodIconPlugin',
                afterDraw: (chart) => {
                    const ctx = chart.ctx;
                    const yAxis = chart.scales.y;
                    const iconSize = 28;
                    
                    [1, 2, 3, 4, 5, 6, 8, 10].forEach(value => {
                        const y = yAxis.getPixelForValue(value);
                        const x = yAxis.left - iconSize - 10;
                        
                        if (moodIcons[value].complete) {
                            ctx.drawImage(moodIcons[value], x, y - iconSize/2, iconSize, iconSize);
                        }
                    });
                }
            };

            // 更新统计数据
            function updateSummary(period) {
                const days = period === 'week' ? 7 : 30;
                const today = new Date();
                const periodData = [];
                
                // 获取对应周期的数据
                for (let i = 0; i < days; i++) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - i);
                    const dateStr = date.toISOString().split('T')[0];
                    const moodEntry = chartMoodData.find(entry => entry.date === dateStr);
                    if (moodEntry) {
                        periodData.push(moodEntry.value);
                    }
                }
                
                // 平均心情
                const avgElement = document.getElementById('averageMood');
                if (periodData.length > 0) {
                    const avg = (periodData.reduce((sum, val) => sum + val, 0) / periodData.length).toFixed(1);
                    avgElement.textContent = avg;
                    avgElement.className = 'value';
                } else {
                    avgElement.textContent = '---';
                    avgElement.className = 'value';
                }
                
                // 最佳状态
                const bestElement = document.getElementById('bestMood');
                if (periodData.length > 0) {
                    const best = Math.max(...periodData).toFixed(1);
                    bestElement.textContent = best;
                    bestElement.className = 'value';
                } else {
                    bestElement.textContent = '---';
                    bestElement.className = 'value';
                }
                
                // 改善趋势
                const trendElement = document.getElementById('trendMood');
                const sortedHistory = [...chartMoodData].sort((a, b) => 
                    new Date(b.date) - new Date(a.date)
                );
                
                if (sortedHistory.length >= 2) {
                    const latestValue = sortedHistory[0].value;
                    const previousValue = sortedHistory[1].value;
                    
                    if (latestValue > previousValue) {
                        trendElement.textContent = '改善中';
                        trendElement.className = 'value positive';
                    } else if (latestValue < previousValue) {
                        trendElement.textContent = '下降';
                        trendElement.className = 'value negative';
                    } else {
                        trendElement.textContent = '稳定';
                        trendElement.className = 'value';
                    }
                } else {
                    trendElement.textContent = '---';
                    trendElement.className = 'value';
                }
            }
            
            // 创建图表函数
            function createChart(period) {
                const days = period === 'week' ? 7 : 30;
                const labels = [];
                const data = [];
                const today = new Date();
                
                for (let i = days - 1; i >= 0; i--) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - i);
                    const dateStr = date.toISOString().split('T')[0];
                    
                    if (period === 'week') {
                        labels.push((date.getMonth() + 1) + '/' + date.getDate());
                    } else {
                        labels.push(date.getDate() + '日');
                    }
                    
                    const moodEntry = chartMoodData.find(entry => entry.date === dateStr);
                    data.push(moodEntry ? moodEntry.value : null);
                }
                
                // 更新统计数据
                updateSummary(period);
                
                if (currentChart) {
                    currentChart.destroy();
                }
                
                const ctx = canvas.getContext('2d');
                currentChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: '心情指数',
                            data: data,
                            borderColor: '#4A90E2',
                            backgroundColor: 'rgba(74, 144, 226, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointRadius: period === 'week' ? 6 : 4,
                            pointHoverRadius: period === 'week' ? 8 : 6,
                            pointBackgroundColor: '#4A90E2',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            spanGaps: true
                        }]
                    },
                    plugins: [moodIconPlugin],
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        layout: {
                            padding: {
                                left: 40
                            }
                        },
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                padding: 12,
                                titleFont: { size: 14 },
                                bodyFont: { size: 13 },
                                callbacks: {
                                    label: function(context) {
                                        if (context.parsed.y === null) {
                                            return '心情: 未打卡';
                                        }
                                        const moodLabels = {
                                            1: '悲伤',
                                            2: '生气',
                                            3: '难过',
                                            4: '尴尬',
                                            5: '紧张',
                                            6: '平静',
                                            8: '微笑',
                                            10: '开心'
                                        };
                                        const score = context.parsed.y;
                                        return '心情: ' + (moodLabels[score] || score + '分');
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 10,
                                min: 0,
                                ticks: {
                                    stepSize: 1,
                                    callback: function(value) {
                                        return '';
                                    },
                                    font: { size: 11 },
                                    color: 'transparent'
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)',
                                    drawBorder: false
                                }
                            },
                            x: {
                                grid: {
                                    display: false,
                                    drawBorder: false
                                },
                                ticks: {
                                    font: { size: 11 },
                                    maxRotation: period === 'month' ? 45 : 0,
                                    minRotation: period === 'month' ? 45 : 0
                                }
                            }
                        }
                    }
                });

                console.log('图表创建成功，模式:', period);
            }

            // 初始化为周视图
            createChart('week');

            // 按钮切换事件
            const tabBtns = document.querySelectorAll('.chart-tabs .tab-btn');
            tabBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    tabBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    const period = this.dataset.period;
                    createChart(period);
                    console.log('切换到', period, '视图');
                });
            });

            console.log('✅ 图表初始化完成');
        });

        // 额外的按钮点击保障
        window.addEventListener('load', function() {
            setTimeout(() => {
                const allButtons = document.querySelectorAll('.btn-view');
                console.log('找到查看报告按钮数量:', allButtons.length);
                allButtons.forEach((btn, index) => {
                    console.log(`按钮 ${index + 1}:`, btn.textContent, '可见性:', btn.offsetParent !== null);
                });
            }, 500);
        });
    </script>
    
    <!-- 引入用户API -->
    <script src="api/user.js"></script>
    
    <!-- 引入个人设置API -->
    <script src="api/profile.js"></script>
    
    <!-- 引入测评报告API -->
    <script src="api/assessment.js"></script>
    
    <!-- 个人设置页面逻辑 -->
    <script>
        // 页面加载完成后初始化个人设置功能
        window.addEventListener('load', async function() {
            console.log('🔄 初始化个人设置页面...');
            
            // 加载用户信息
            await loadUserProfile();
            
            // 加载成就勋章
            await loadAchievements();
            
            // 初始化设置模态框事件
            initSettingsModal();
        });
        
        /**
         * 加载用户个人信息
         */
        async function loadUserProfile() {
            try {
                const result = await ProfileAPI.getUserProfile();
                
                if (result.success) {
                    const profile = result.data;
                    console.log('✅ 用户信息加载成功:', profile);
                    
                    // 更新页面上的用户信息
                    updateProfileDisplay(profile);
                } else {
                    console.error('❌ 加载用户信息失败:', result.message);
                }
            } catch (error) {
                console.error('❌ 加载用户信息错误:', error);
            }
        }
        
        /**
         * 更新页面显示的用户信息
         */
        function updateProfileDisplay(profile) {
            // 更新顶部信息
            const daysElement = document.querySelector('.profile-header-new p .highlight');
            if (daysElement) {
                daysElement.textContent = profile.daysFromRegistration;
            }
            
            // 更新统计卡片
            const statCards = document.querySelectorAll('.stat-card-new .stat-number');
            if (statCards.length >= 3) {
                statCards[0].textContent = profile.statistics.totalCheckins; // 打卡天数
                statCards[1].textContent = profile.statistics.totalPractices; // 练习次数
                statCards[2].textContent = profile.statistics.totalAssessments; // 完成测评
            }
            
            // 更新设置模态框中的信息
            const nicknameInput = document.getElementById('userNickname');
            const phoneInput = document.getElementById('userPhone');
            const birthdayInput = document.getElementById('userBirthday');
            const genderInputs = document.querySelectorAll('input[name="gender"]');
            
            if (nicknameInput) nicknameInput.value = profile.nickname;
            if (phoneInput) phoneInput.value = profile.phone;
            if (birthdayInput) birthdayInput.value = profile.birthday;
            
            // 设置性别单选框
            genderInputs.forEach(input => {
                if (input.value === profile.gender) {
                    input.checked = true;
                }
            });
            
            // 更新头像
            if (profile.avatar) {
                updateAvatarDisplay(profile.avatar);
            }
        }
        
        /**
         * 更新头像显示
         */
        function updateAvatarDisplay(avatarUrl) {
            const avatarPreview = document.getElementById('avatarPreview');
            if (avatarPreview && avatarUrl) {
                avatarPreview.innerHTML = `<img src="${avatarUrl}" alt="头像" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
            }
        }
        
        /**
         * 加载成就勋章
         */
        async function loadAchievements() {
            try {
                const result = await ProfileAPI.getAchievements();
                
                if (result.success) {
                    console.log('✅ 成就勋章加载成功');
                    updateAchievementsDisplay(result.data);
                } else {
                    console.error('❌ 加载成就失败:', result.message);
                }
            } catch (error) {
                console.error('❌ 加载成就错误:', error);
            }
        }
        
        /**
         * 更新成就勋章显示
         */
        function updateAchievementsDisplay(achievements) {
            const achievementsGrid = document.querySelector('.achievements-grid-sidebar');
            if (!achievementsGrid) return;
            
            // 清空现有内容
            achievementsGrid.innerHTML = '';
            
            // 只显示已解锁的成就（前6个）
            const unlockedAchievements = achievements.filter(a => a.unlocked).slice(0, 6);
            
            unlockedAchievements.forEach(achievement => {
                const card = document.createElement('div');
                card.className = `achievement-card ${achievement.unlocked ? 'unlocked' : 'locked'}`;
                card.innerHTML = `
                    <div class="achievement-icon ${achievement.color}">
                        <i class="fas ${achievement.icon}"></i>
                    </div>
                    <h3>${achievement.name}</h3>
                    <p>${achievement.description}</p>
                    ${achievement.unlocked ? `<span class="date">${achievement.unlockedDate}</span>` : ''}
                `;
                achievementsGrid.appendChild(card);
            });
        }
        
        /**
         * 初始化设置模态框
         */
        function initSettingsModal() {
            const settingsModal = document.getElementById('settingsModal');
            const openSettingsBtn = document.querySelector('.btn-settings');
            const closeSettingsBtn = document.getElementById('closeSettings');
            const saveSettingsBtn = document.getElementById('saveSettings');
            const uploadAvatarBtn = document.getElementById('uploadAvatarBtn');
            const avatarInput = document.getElementById('avatarInput');
            
            // 打开设置模态框
            if (openSettingsBtn) {
                openSettingsBtn.addEventListener('click', function() {
                    settingsModal.classList.add('active');
                });
            }
            
            // 关闭设置模态框
            if (closeSettingsBtn) {
                closeSettingsBtn.addEventListener('click', function() {
                    settingsModal.classList.remove('active');
                });
            }
            
            // 点击背景关闭
            const backdrop = document.querySelector('.settings-backdrop');
            if (backdrop) {
                backdrop.addEventListener('click', function() {
                    settingsModal.classList.remove('active');
                });
            }
            
            // 上传头像按钮
            if (uploadAvatarBtn && avatarInput) {
                uploadAvatarBtn.addEventListener('click', function() {
                    avatarInput.click();
                });
                
                avatarInput.addEventListener('change', async function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        await handleAvatarUpload(file);
                    }
                });
            }
            
            // 保存设置
            if (saveSettingsBtn) {
                saveSettingsBtn.addEventListener('click', async function() {
                    await handleSaveSettings();
                });
            }
        }
        
        /**
         * 处理头像上传
         */
        async function handleAvatarUpload(file) {
            try {
                console.log('📤 上传头像...', file.name);
                
                const result = await ProfileAPI.uploadAvatar(file);
                
                if (result.success) {
                    console.log('✅ 头像上传成功');
                    updateAvatarDisplay(result.data.avatar);
                    showMessage('头像上传成功！', 'success');
                } else {
                    console.error('❌ 头像上传失败:', result.message);
                    showMessage(result.message, 'error');
                }
            } catch (error) {
                console.error('❌ 头像上传错误:', error);
                showMessage('头像上传失败，请稍后重试', 'error');
            }
        }
        
        /**
         * 处理保存设置
         */
        async function handleSaveSettings() {
            try {
                const nicknameInput = document.getElementById('userNickname');
                const birthdayInput = document.getElementById('userBirthday');
                const genderInput = document.querySelector('input[name="gender"]:checked');
                
                const settings = {
                    nickname: nicknameInput.value.trim(),
                    birthday: birthdayInput.value,
                    gender: genderInput ? genderInput.value : 'female'
                };
                
                console.log('💾 保存设置...', settings);
                
                const result = await ProfileAPI.updateProfile(settings);
                
                if (result.success) {
                    console.log('✅ 设置保存成功');
                    showMessage('设置保存成功！', 'success');
                    
                    // 重新加载用户信息
                    setTimeout(() => {
                        loadUserProfile();
                    }, 500);
                    
                    // 关闭模态框
                    setTimeout(() => {
                        document.getElementById('settingsModal').classList.remove('active');
                    }, 1000);
                } else {
                    console.error('❌ 保存设置失败:', result.message);
                    showMessage(result.message, 'error');
                }
            } catch (error) {
                console.error('❌ 保存设置错误:', error);
                showMessage('保存失败，请稍后重试', 'error');
            }
        }
        
        /**
         * 显示消息提示
         */
        function showMessage(message, type = 'info') {
            // 创建消息提示元素
            const messageEl = document.createElement('div');
            messageEl.className = `message-toast message-${type}`;
            messageEl.textContent = message;
            messageEl.style.cssText = `
                position: fixed;
                top: 80px;
                left: 50%;
                transform: translateX(-50%);
                padding: 12px 24px;
                background: ${type === 'success' ? '#5FD3A6' : type === 'error' ? '#FF6B9D' : '#4A90E2'};
                color: white;
                border-radius: 8px;
                font-size: 14px;
                z-index: 10000;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                animation: slideDown 0.3s ease;
            `;
            
            document.body.appendChild(messageEl);
            
            // 3秒后自动移除
            setTimeout(() => {
                messageEl.style.animation = 'slideUp 0.3s ease';
                setTimeout(() => {
                    messageEl.remove();
                }, 300);
            }, 3000);
        }
    </script>
    
    <!-- 引入主 JS -->
    <script src="js/main.js"></script>
	</body>
</html>
