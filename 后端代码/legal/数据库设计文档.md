<!-- # 法智顾问 - 数据库设计文档

## 1. 数据库概述

### 1.1 数据库信息
- **数据库名称**: `legal_assistant`
- **数据库类型**: MySQL 8.0+
- **字符集**: `utf8mb4`
- **排序规则**: `utf8mb4_unicode_ci`
- **存储引擎**: InnoDB

### 1.2 设计原则
- 使用UUID作为主键（VARCHAR(50)）
- 统一使用 `created_at` 和 `updated_at` 时间戳字段
- 所有表都使用InnoDB引擎，支持事务和外键约束
- 合理使用索引优化查询性能
- JSON字段存储复杂结构数据（MySQL 5.7+支持）

---

## 2. 数据表设计

### 2.1 用户表 (users)

**表名**: `users`  
**说明**: 存储用户基本信息

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | VARCHAR(50) | PRIMARY KEY | 用户ID（UUID） |
| phone | VARCHAR(11) | UNIQUE, NOT NULL | 手机号（唯一） |
| password | VARCHAR(255) | NOT NULL | 密码（BCrypt加密） |
| nickname | VARCHAR(50) | | 昵称 |
| avatar | VARCHAR(500) | | 头像URL |
| email | VARCHAR(100) | | 邮箱 |
| gender | VARCHAR(10) | DEFAULT 'unknown' | 性别：male/female/unknown |
| status | INT | DEFAULT 1 | 状态：1-正常，0-禁用 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

**索引**:
- PRIMARY KEY (id)
- UNIQUE KEY uk_phone (phone)
- INDEX idx_status (status)

---

### 2.2 验证码表 (verification_codes)

**表名**: `verification_codes`  
**说明**: 存储短信验证码（用于注册、找回密码等）

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | VARCHAR(50) | PRIMARY KEY | 记录ID |
| phone | VARCHAR(11) | NOT NULL | 手机号 |
| code | VARCHAR(6) | NOT NULL | 验证码 |
| type | VARCHAR(20) | NOT NULL | 类型：register/reset_password |
| expired_at | TIMESTAMP | NOT NULL | 过期时间（5分钟） |
| used | INT | DEFAULT 0 | 是否已使用：0-未使用，1-已使用 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 创建时间 |

**索引**:
- PRIMARY KEY (id)
- INDEX idx_phone_type (phone, type)
- INDEX idx_expired_at (expired_at)

---

### 2.3 对话表 (conversations)

**表名**: `conversations`  
**说明**: 存储AI咨询对话会话

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | VARCHAR(50) | PRIMARY KEY | 对话ID |
| user_id | VARCHAR(50) | NOT NULL, FK | 用户ID |
| title | VARCHAR(200) | | 对话标题（自动生成） |
| first_message | TEXT | | 第一条消息内容 |
| message_count | INT | DEFAULT 0 | 消息数量 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

**索引**:
- PRIMARY KEY (id)
- FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
- INDEX idx_user_id (user_id)
- INDEX idx_created_at (created_at)

---

### 2.4 消息表 (messages)

**表名**: `messages`  
**说明**: 存储对话中的消息记录

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | VARCHAR(50) | PRIMARY KEY | 消息ID |
| conversation_id | VARCHAR(50) | NOT NULL, FK | 对话ID |
| role | VARCHAR(20) | NOT NULL | 角色：user/assistant |
| content | TEXT | NOT NULL | 消息内容 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 创建时间 |

**索引**:
- PRIMARY KEY (id)
- FOREIGN KEY (conversation_id) REFERENCES conversations(id) ON DELETE CASCADE
- INDEX idx_conversation_id (conversation_id)
- INDEX idx_created_at (created_at)

---

### 2.5 法律法规表 (legal_regulations)

**表名**: `legal_regulations`  
**说明**: 存储法律法规信息

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | VARCHAR(50) | PRIMARY KEY | 法规ID |
| title | VARCHAR(300) | NOT NULL | 法规标题 |
| article_count | INT | DEFAULT 0 | 条款数量 |
| category | VARCHAR(50) | | 分类：宪法/民法/刑法等 |
| effective_date | DATE | | 生效日期 |
| update_date | DATE | | 更新日期 |
| status | VARCHAR(20) | DEFAULT '有效' | 状态：有效/失效/修订 |
| content | LONGTEXT | | 法规全文（HTML格式） |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 创建时间 |

**索引**:
- PRIMARY KEY (id)
- INDEX idx_category (category)
- INDEX idx_title (title)
- INDEX idx_status (status)
- FULLTEXT idx_fulltext (title, content) -- 全文索引

---

### 2.6 案例表 (legal_cases)

**表名**: `legal_cases`  
**说明**: 存储法律案例信息

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | VARCHAR(50) | PRIMARY KEY | 案例ID |
| title | VARCHAR(500) | NOT NULL | 案例标题 |
| case_number | VARCHAR(100) | | 案号 |
| case_type | VARCHAR(50) | | 案件类型：民事/刑事/行政等 |
| court | VARCHAR(200) | | 审理法院 |
| publish_date | DATE | | 发布日期 |
| content | JSON | | 案例内容（JSON格式） |
| keywords | JSON | | 关键词数组 |
| related_laws | JSON | | 相关法条数组 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 创建时间 |

**索引**:
- PRIMARY KEY (id)
- INDEX idx_case_type (case_type)
- INDEX idx_court (court)
- INDEX idx_publish_date (publish_date)
- FULLTEXT idx_title (title) -- 全文索引

**JSON字段说明**:
- `content`: 包含 basic_info、sections 等结构
- `keywords`: 字符串数组，如 ["劳动争议", "经济补偿金"]
- `related_laws`: 字符串数组，如 ["《劳动合同法》第四十条"]

---

### 2.7 文书模板表 (document_templates)

**表名**: `document_templates`  
**说明**: 存储法律文书模板

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | VARCHAR(50) | PRIMARY KEY | 模板ID |
| title | VARCHAR(200) | NOT NULL | 模板标题 |
| description | TEXT | | 模板描述 |
| category | VARCHAR(50) | | 分类：劳动合同/起诉状/合同等 |
| file_url | VARCHAR(500) | | 文件URL |
| file_size | BIGINT | DEFAULT 0 | 文件大小（字节） |
| file_type | VARCHAR(20) | DEFAULT 'pdf' | 文件类型：pdf/docx |
| download_count | INT | DEFAULT 0 | 下载次数 |
| preview_url | VARCHAR(500) | | 预览图URL |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

**索引**:
- PRIMARY KEY (id)
- INDEX idx_category (category)
- INDEX idx_download_count (download_count)

---

### 2.8 收藏表 (favorites)

**表名**: `favorites`  
**说明**: 存储用户收藏的法规

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | VARCHAR(50) | PRIMARY KEY | 收藏ID |
| user_id | VARCHAR(50) | NOT NULL, FK | 用户ID |
| regulation_id | VARCHAR(50) | NOT NULL, FK | 法规ID |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 创建时间 |

**索引**:
- PRIMARY KEY (id)
- FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
- FOREIGN KEY (regulation_id) REFERENCES legal_regulations(id) ON DELETE CASCADE
- UNIQUE KEY uk_user_regulation (user_id, regulation_id)
- INDEX idx_user_id (user_id)

---

### 2.9 工具使用记录表 (tool_usage_records)

**表名**: `tool_usage_records`  
**说明**: 记录用户使用各种法律工具的历史

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | VARCHAR(50) | PRIMARY KEY | 记录ID |
| user_id | VARCHAR(50) | NOT NULL, FK | 用户ID |
| tool_type | VARCHAR(50) | NOT NULL | 工具类型：calculator/document_review等 |
| tool_name | VARCHAR(100) | | 工具名称：compensation/work_injury等 |
| input_data | JSON | | 输入数据 |
| result_data | JSON | | 结果数据 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 创建时间 |

**索引**:
- PRIMARY KEY (id)
- FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
- INDEX idx_user_tool (user_id, tool_type)
- INDEX idx_created_at (created_at)

---

### 2.10 下载记录表 (download_records)

**表名**: `download_records`  
**说明**: 记录用户下载文书模板的历史

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | VARCHAR(50) | PRIMARY KEY | 记录ID |
| user_id | VARCHAR(50) | NOT NULL, FK | 用户ID |
| template_id | VARCHAR(50) | NOT NULL, FK | 模板ID |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 创建时间 |

**索引**:
- PRIMARY KEY (id)
- FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
- FOREIGN KEY (template_id) REFERENCES document_templates(id) ON DELETE CASCADE
- INDEX idx_user_id (user_id)
- INDEX idx_template_id (template_id)
- INDEX idx_created_at (created_at)

---

### 2.11 文件审查记录表 (document_reviews)

**表名**: `document_reviews`  
**说明**: 记录用户上传文件进行AI审查的历史

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | VARCHAR(50) | PRIMARY KEY | 审查ID |
| user_id | VARCHAR(50) | NOT NULL, FK | 用户ID |
| file_name | VARCHAR(255) | NOT NULL | 文件名 |
| file_url | VARCHAR(500) | | 文件URL |
| file_size | BIGINT | DEFAULT 0 | 文件大小（字节） |
| file_type | VARCHAR(20) | | 文件类型：pdf/docx |
| suggestions | JSON | | 审查建议（JSON数组） |
| overall_score | INT | | 总体评分（0-100） |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 创建时间 |

**索引**:
- PRIMARY KEY (id)
- FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
- INDEX idx_user_id (user_id)
- INDEX idx_created_at (created_at)

**JSON字段说明**:
`suggestions` 格式：
```json
[
  {
    "type": "warning",
    "title": "违约责任条款不明确",
    "description": "第5条违约责任条款描述过于笼统...",
    "severity": "medium"
  }
]
```

---

### 2.12 案例搜索历史表 (case_search_history)

**表名**: `case_search_history`  
**说明**: 记录用户的案例搜索历史

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | VARCHAR(50) | PRIMARY KEY | 记录ID |
| user_id | VARCHAR(50) | NOT NULL, FK | 用户ID |
| keyword | VARCHAR(200) | | 搜索关键词 |
| case_type | VARCHAR(50) | | 案件类型 |
| court | VARCHAR(200) | | 法院 |
| result_count | INT | DEFAULT 0 | 结果数量 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 创建时间 |

**索引**:
- PRIMARY KEY (id)
- FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
- INDEX idx_user_id (user_id)
- INDEX idx_created_at (created_at)

---

## 3. 表关系图

```
users (用户表)
  ├── conversations (对话表) - 1:N
  │     └── messages (消息表) - 1:N
  ├── favorites (收藏表) - 1:N
  ├── tool_usage_records (工具使用记录) - 1:N
  ├── download_records (下载记录) - 1:N
  ├── document_reviews (文件审查记录) - 1:N
  └── case_search_history (搜索历史) - 1:N

legal_regulations (法律法规表)
  └── favorites (收藏表) - 1:N

document_templates (文书模板表)
  └── download_records (下载记录) - 1:N
```

---

## 4. 数据库初始化建议

### 4.1 创建数据库
```sql
CREATE DATABASE IF NOT EXISTS legal_assistant 
  DEFAULT CHARACTER SET utf8mb4 
  DEFAULT COLLATE utf8mb4_unicode_ci;
```

### 4.2 执行顺序
1. 先创建基础表（users）
2. 创建关联表（conversations, messages等）
3. 创建独立表（legal_regulations, legal_cases等）
4. 创建关联表（favorites, download_records等）

### 4.3 初始化数据建议
- 法律法规表：导入基础法规数据
- 案例表：导入示例案例数据
- 文书模板表：上传常用模板

---

## 5. Spring Boot JPA 实体类设计建议

### 5.1 通用字段基类
建议创建 `BaseEntity` 基类，包含：
- `id` (String)
- `createdAt` (LocalDateTime)
- `updatedAt` (LocalDateTime)

### 5.2 JSON字段处理
- 使用 `@Type(type = "json")` 或 `@JdbcTypeCode(SqlTypes.JSON)` 注解
- 或使用 `@Column(columnDefinition = "json")` 配合自定义转换器

### 5.3 枚举类型
- 性别：使用 `@Enumerated(EnumType.STRING)`
- 状态：建议使用枚举类

### 5.4 关联关系
- 使用 `@OneToMany` 和 `@ManyToOne` 注解
- 设置 `cascade = CascadeType.ALL` 和 `orphanRemoval = true` 实现级联删除

---

## 6. 性能优化建议

### 6.1 索引优化
- 为常用查询字段建立索引
- 为外键字段建立索引
- 使用复合索引优化多字段查询

### 6.2 分页查询
- 所有列表查询都使用分页
- 默认每页20条记录

### 6.3 全文搜索
- 法律法规和案例使用全文索引
- 考虑使用Elasticsearch进行高级搜索

### 6.4 数据归档
- 定期归档历史消息和记录
- 考虑使用分区表存储大量历史数据

---

## 7. 安全建议

### 7.1 密码存储
- 使用BCrypt加密存储密码
- 密码字段长度至少255字符

### 7.2 敏感信息
- 不在日志中输出敏感信息
- 使用HTTPS传输数据

### 7.3 数据备份
- 定期备份数据库
- 保留最近30天的备份

---

**文档版本**: v1.0  
**创建日期**: 2024-01-01  
**最后更新**: 2024-01-01
 -->
