# 文件审查接口500错误排查指南

## 🔍 问题分析

根据你的测试结果，四个文件审查接口都返回了500错误。经过代码检查，我发现了以下可能的原因：

### 1. **不是因为没有接入AI**
代码中已经有模拟AI审查的逻辑（`performAIReview`方法），所以500错误**不是因为AI未接入**。

### 2. **可能的原因**

#### 原因1：JWT Token问题
- **症状**：如果Token无效、过期或未正确传递，JWT拦截器可能无法正确设置`userId`
- **检查方法**：
  1. 确认Apifox中已正确设置`Authorization: Bearer {{token}}`
  2. 确认Token是通过登录接口获取的最新Token
  3. 检查Token是否过期（默认24小时）

#### 原因2：参数缺失或为空
- **症状**：DELETE接口的`id`参数为空（从你的截图可见）
- **检查方法**：
  1. GET详情接口：确保URL中的`{id}`参数已填写（如：`review_001`）
  2. DELETE接口：确保URL中的`{id}`参数已填写（如：`review_003`）
  3. POST上传接口：确保`file`参数已选择文件

#### 原因3：数据库连接或查询问题
- **症状**：用户不存在、记录不存在、数据库连接失败
- **检查方法**：
  1. 确认数据库服务已启动
  2. 确认测试数据已插入（执行`test_data.sql`）
  3. 确认用户ID `cd9194ea-a580-458e-bc80-1e5b529a4c13` 存在

#### 原因4：文件系统权限问题
- **症状**：文件上传失败（POST接口）
- **检查方法**：
  1. 确认`uploads`目录存在且有写权限
  2. 检查`application.properties`中的`app.upload-dir`配置

---

## ✅ 已修复的问题

我已经对代码进行了以下修复：

### 1. **添加了参数验证**
- ✅ Controller层添加了`userId`空值检查
- ✅ Controller层添加了`id`参数验证
- ✅ Service层添加了所有参数的空值检查

### 2. **改进了错误处理**
- ✅ 异常处理会打印堆栈信息（便于调试）
- ✅ 提供了更友好的错误信息
- ✅ 区分了不同类型的错误（400 vs 500）

### 3. **增强了接口健壮性**
- ✅ 所有接口都有完整的参数验证
- ✅ 提供了明确的错误提示

---

## 🔧 排查步骤

### 第一步：检查Token

1. **重新登录获取Token**：
   ```http
   POST http://localhost:8080/api/auth/login
   Content-Type: application/json
   
   {
     "phone": "13900139000",
     "password": "123456"
   }
   ```

2. **验证Token是否有效**：
   - 检查响应中的`token`字段
   - 在Apifox中设置环境变量`token`
   - 确保所有请求的Header中都包含：`Authorization: Bearer {{token}}`

### 第二步：检查参数

#### GET 获取审查历史
```
URL: http://localhost:8080/api/legal-tools/document-review/history?page=1&pageSize=10
Headers: Authorization: Bearer {{token}}
```

#### GET 获取审查详情
```
URL: http://localhost:8080/api/legal-tools/document-review/review_001
Headers: Authorization: Bearer {{token}}
```
⚠️ **注意**：URL中的`review_001`必须填写，不能为空！

#### DELETE 删除审查记录
```
URL: http://localhost:8080/api/legal-tools/document-review/review_003
Method: DELETE
Headers: Authorization: Bearer {{token}}
```
⚠️ **注意**：URL中的`review_003`必须填写，不能为空！

#### POST 上传文件审查
```
URL: http://localhost:8080/api/legal-tools/document-review
Method: POST
Headers: Authorization: Bearer {{token}}
Body: form-data
  - file: [选择PDF或DOCX文件]
```

### 第三步：检查数据库

1. **确认测试数据已插入**：
   ```sql
   -- 检查用户
   SELECT id, phone, nickname FROM users 
   WHERE id = 'cd9194ea-a580-458e-bc80-1e5b529a4c13';
   
   -- 检查文件审查记录
   SELECT id, file_name, overall_score, created_at 
   FROM document_reviews 
   WHERE user_id = 'cd9194ea-a580-458e-bc80-1e5b529a4c13'
   ORDER BY created_at DESC;
   ```

2. **如果数据不存在，执行测试数据脚本**：
   ```bash
   mysql -u root -p123456 legal_assistant < src/main/resources/db/test_data.sql
   ```

### 第四步：查看后端日志

启动后端服务后，查看控制台输出的错误信息：

1. **如果看到"用户ID不能为空"**：
   - 说明JWT拦截器未正确设置userId
   - 检查Token是否有效
   - 检查Header中是否正确传递了Authorization

2. **如果看到"审查记录不存在"**：
   - 说明数据库中没有对应的记录
   - 执行测试数据脚本插入数据

3. **如果看到"文件上传失败"**：
   - 检查`uploads`目录权限
   - 检查磁盘空间

---

## 📋 接口参数说明

### 1. POST 上传文件进行AI审查

**必需参数**：
- `file` (MultipartFile): 文件，必须是PDF或DOCX格式，大小不超过10MB

**Header**：
- `Authorization: Bearer {token}`

**响应示例**：
```json
{
  "code": 200,
  "message": "审查完成",
  "data": {
    "id": "review_004",
    "fileName": "test.pdf",
    "fileSize": 245760,
    "fileType": "pdf",
    "overallScore": 85,
    "suggestions": [...],
    "createdAt": "2024-01-15T10:30:00"
  }
}
```

---

### 2. GET 获取审查历史记录列表

**查询参数**（可选）：
- `page` (Integer, 默认1): 页码
- `pageSize` (Integer, 默认10): 每页数量

**Header**：
- `Authorization: Bearer {token}`

**响应示例**：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "items": [...],
    "total": 3,
    "page": 1,
    "pageSize": 10,
    "totalPages": 1
  }
}
```

---

### 3. GET 获取审查记录详情

**路径参数**（必需）：
- `id` (String): 审查记录ID，例如：`review_001`

**Header**：
- `Authorization: Bearer {token}`

⚠️ **重要**：URL中必须包含ID，例如：
```
GET /api/legal-tools/document-review/review_001
```

**响应示例**：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": "review_001",
    "fileName": "劳动合同.pdf",
    "fileUrl": "/uploads/documents/...",
    "fileSize": 245760,
    "fileType": "pdf",
    "overallScore": 85,
    "suggestions": [...],
    "createdAt": "2024-01-09T10:30:00",
    "updatedAt": "2024-01-09T10:30:00"
  }
}
```

---

### 4. DELETE 删除审查记录

**路径参数**（必需）：
- `id` (String): 审查记录ID，例如：`review_003`

**Header**：
- `Authorization: Bearer {token}`

⚠️ **重要**：URL中必须包含ID，例如：
```
DELETE /api/legal-tools/document-review/review_003
```

**响应示例**：
```json
{
  "code": 200,
  "message": "删除成功",
  "data": null
}
```

---

## 🐛 常见错误及解决方案

### 错误1：HTTP 500 - "服务器内部错误"

**可能原因**：
1. Token无效或过期
2. 参数为空或格式错误
3. 数据库连接失败
4. 文件系统权限问题

**解决方案**：
1. 重新登录获取新Token
2. 检查所有必需参数是否已填写
3. 检查数据库服务是否运行
4. 查看后端控制台的详细错误信息

---

### 错误2：HTTP 401 - "未授权，请先登录"

**原因**：Token缺失、无效或过期

**解决方案**：
1. 重新调用登录接口获取Token
2. 在Apifox中设置环境变量`token`
3. 确保所有请求Header中包含`Authorization: Bearer {{token}}`

---

### 错误3：HTTP 400 - "审查记录ID不能为空"

**原因**：URL中的`{id}`参数未填写

**解决方案**：
- GET详情：`/api/legal-tools/document-review/review_001`（不是`/{id}`）
- DELETE：`/api/legal-tools/document-review/review_003`（不是`/{id}`）

---

### 错误4：HTTP 400 - "审查记录不存在"

**原因**：数据库中不存在该ID的记录

**解决方案**：
1. 先调用`GET /history`查看所有记录ID
2. 使用存在的ID进行测试
3. 或执行测试数据脚本插入数据

---

## 📝 测试检查清单

- [ ] 后端服务已启动（端口8080）
- [ ] 数据库服务已启动
- [ ] 测试数据已插入（执行`test_data.sql`）
- [ ] 已登录并获取Token
- [ ] Apifox环境变量`token`已设置
- [ ] 所有请求Header中包含`Authorization: Bearer {{token}}`
- [ ] GET详情接口的URL中已填写ID（如：`review_001`）
- [ ] DELETE接口的URL中已填写ID（如：`review_003`）
- [ ] POST上传接口已选择文件（PDF或DOCX格式）

---

## 🔍 调试技巧

### 1. 查看后端日志

启动后端后，所有异常都会打印到控制台。查看完整的堆栈信息可以帮助定位问题。

### 2. 使用Apifox的"实际请求"功能

在Apifox的响应面板中，点击"实际请求"标签，可以查看实际发送的HTTP请求，确认：
- Header是否正确
- URL是否正确
- Body是否正确

### 3. 逐步测试

按照以下顺序测试：
1. 先测试最简单的接口：`GET /history`（只需要Token）
2. 再测试需要ID的接口：`GET /{id}`（需要Token和ID）
3. 最后测试需要文件的接口：`POST /`（需要Token和文件）

---

## 📞 如果问题仍未解决

如果按照以上步骤排查后问题仍未解决，请提供以下信息：

1. **后端控制台的完整错误堆栈**
2. **Apifox中的实际请求详情**（点击"实际请求"标签）
3. **数据库查询结果**（执行上面的SQL检查用户和记录是否存在）
4. **Token信息**（是否通过登录接口获取，是否过期）

---

**最后更新**: 2024年  
**适用版本**: v1.0

