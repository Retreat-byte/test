# 使用现有用户测试文件审查接口指南

> 用户ID: `cd9194ea-a580-458e-bc80-1e5b529a4c13`  
> 手机号: `13900139000`  
> 密码: `123456`

---

## 🎯 快速开始

### 第一步：插入测试数据

由于用户已存在，只需要为这个用户插入文件审查记录等测试数据：

```bash
# 执行测试数据脚本（会清理该用户的旧数据并插入新数据）
mysql -u root -p123456 legal_assistant < src/main/resources/db/test_data.sql
```

**或者使用 Windows 批处理脚本**：
```cmd
# 双击运行
insert-test-data-for-user.cmd
```

### 第二步：启动后端服务

```bash
cd 后端代码/legal
start-backend.cmd
```

**服务地址**: `http://localhost:8080`

### 第三步：在 Apifox 中测试

---

## 📋 Apifox 配置

### 1. 环境变量设置

创建或编辑环境：`法智顾问-本地测试`

| 变量名 | 初始值 | 说明 |
|--------|--------|------|
| `baseUrl` | `http://localhost:8080` | 后端服务地址 |
| `token` | (空) | JWT Token（登录后自动设置） |

### 2. 登录获取 Token

**接口**: `POST /api/auth/login`

**请求配置**：
- URL: `{{baseUrl}}/api/auth/login`
- Method: `POST`
- Headers: `Content-Type: application/json`

**请求体**：
```json
{
  "phone": "13900139000",
  "password": "123456"
}
```

**响应示例**：
```json
{
  "code": 200,
  "message": "登录成功",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "userInfo": {
      "id": "cd9194ea-a580-458e-bc80-1e5b529a4c13",
      "phone": "13900139000",
      "nickname": "测试用户1"
    }
  }
}
```

**配置后置操作**：
1. 在 Apifox 中，点击该接口的 **"后置操作"** 标签
2. 添加 **"提取变量"**：
   - 变量名：`token`
   - 提取表达式：`$.data.token`
   - 作用域：`环境变量`

---

## 📁 文件审查接口测试

### 接口列表

| 序号 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 1 | POST | `/api/legal-tools/document-review` | 上传文件进行审查 |
| 2 | GET | `/api/legal-tools/document-review/history` | 获取审查历史列表 |
| 3 | GET | `/api/legal-tools/document-review/{id}` | 获取审查详情 |
| 4 | DELETE | `/api/legal-tools/document-review/{id}` | 删除审查记录 |

**所有接口都需要在 Header 中添加**：
```
Authorization: Bearer {{token}}
```

---

### 接口 1：上传文件审查

**接口**: `POST /api/legal-tools/document-review`

**请求配置**：
- URL: `{{baseUrl}}/api/legal-tools/document-review`
- Method: `POST`
- Headers: 
  - `Authorization: Bearer {{token}}`
  - `Content-Type: multipart/form-data`
- Body: 选择 `form-data`，添加字段：
  - 字段名：`file`
  - 类型：`File`
  - 值：选择一个 PDF 或 DOCX 文件

**响应示例**：
```json
{
  "code": 200,
  "message": "审查完成",
  "data": {
    "id": "review_004",
    "fileName": "test_document.pdf",
    "fileSize": 245760,
    "fileType": "pdf",
    "overallScore": 85,
    "suggestions": [
      {
        "type": "warning",
        "title": "试用期约定过长",
        "description": "建议明确具体期限",
        "severity": "medium"
      }
    ],
    "createdAt": "2024-01-15T10:30:00"
  }
}
```

---

### 接口 2：获取审查历史列表

**接口**: `GET /api/legal-tools/document-review/history`

**请求配置**：
- URL: `{{baseUrl}}/api/legal-tools/document-review/history?page=1&pageSize=10`
- Method: `GET`
- Headers: `Authorization: Bearer {{token}}`

**响应示例**：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "items": [
      {
        "id": "review_001",
        "fileName": "劳动合同.pdf",
        "fileSize": 245760,
        "fileType": "pdf",
        "overallScore": 85,
        "createdAt": "2024-01-09T10:30:00"
      },
      {
        "id": "review_002",
        "fileName": "解除通知书.docx",
        "fileSize": 189440,
        "fileType": "docx",
        "overallScore": 65,
        "createdAt": "2024-01-12T14:20:00"
      },
      {
        "id": "review_003",
        "fileName": "保密协议.pdf",
        "fileSize": 156672,
        "fileType": "pdf",
        "overallScore": 90,
        "createdAt": "2024-01-14T16:10:00"
      }
    ],
    "total": 3,
    "page": 1,
    "pageSize": 10,
    "totalPages": 1
  }
}
```

**预期结果**：应该返回 **3条记录**（review_001, review_002, review_003）

---

### 接口 3：获取审查详情

**接口**: `GET /api/legal-tools/document-review/{id}`

**请求配置**：
- URL: `{{baseUrl}}/api/legal-tools/document-review/review_001`
- Method: `GET`
- Headers: `Authorization: Bearer {{token}}`

**响应示例**：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": "review_001",
    "fileName": "劳动合同.pdf",
    "fileUrl": "/uploads/reviews/contract_001.pdf",
    "fileSize": 245760,
    "fileType": "pdf",
    "overallScore": 85,
    "suggestions": [
      {
        "type": "warning",
        "title": "试用期约定过长",
        "description": "劳动合同约定试用期为6个月，但根据《劳动合同法》规定，三年以上固定期限劳动合同试用期最长不超过6个月，建议明确具体期限。",
        "severity": "medium"
      },
      {
        "type": "info",
        "title": "工作地点约定明确",
        "description": "工作地点约定清晰，符合要求。",
        "severity": "low"
      },
      {
        "type": "warning",
        "title": "违约金条款需注意",
        "description": "违约金条款约定较为严格，建议确认是否符合法律规定。",
        "severity": "medium"
      }
    ],
    "createdAt": "2024-01-09T10:30:00",
    "updatedAt": "2024-01-09T10:30:00"
  }
}
```

**测试用例**：
- ✅ 使用 `review_001`（应返回成功）
- ✅ 使用 `review_002`（应返回成功）
- ✅ 使用 `review_003`（应返回成功）
- ❌ 使用不存在的ID（如 `review_999`，应返回404）

---

### 接口 4：删除审查记录

**接口**: `DELETE /api/legal-tools/document-review/{id}`

**请求配置**：
- URL: `{{baseUrl}}/api/legal-tools/document-review/review_003`
- Method: `DELETE`
- Headers: `Authorization: Bearer {{token}}`

**响应示例**：
```json
{
  "code": 200,
  "message": "删除成功",
  "data": null
}
```

**测试流程**：
1. 先调用 `GET /history` 确认有3条记录
2. 调用 `DELETE /review_003` 删除一条
3. 再次调用 `GET /history` 确认只剩2条记录
4. 调用 `GET /review_003` 确认返回错误（记录不存在）

---

## ✅ 测试检查清单

- [ ] 已执行测试数据脚本（`test_data.sql`）
- [ ] 后端服务已启动（端口8080）
- [ ] Apifox 环境已配置（baseUrl 和 token）
- [ ] 已登录并获取 Token
- [ ] ✅ 接口1：上传文件审查测试通过
- [ ] ✅ 接口2：获取历史列表测试通过（应返回3条记录）
- [ ] ✅ 接口3：获取详情测试通过（使用 review_001）
- [ ] ✅ 接口4：删除记录测试通过（使用 review_003）
- [ ] ✅ 删除后验证记录已从列表中移除

---

## 🔍 验证测试数据

执行以下 SQL 验证数据：

```sql
-- 检查用户
SELECT id, phone, nickname FROM users WHERE id = 'cd9194ea-a580-458e-bc80-1e5b529a4c13';

-- 检查文件审查记录
SELECT id, file_name, overall_score, created_at 
FROM document_reviews 
WHERE user_id = 'cd9194ea-a580-458e-bc80-1e5b529a4c13'
ORDER BY created_at DESC;
```

**预期结果**：
- 用户：1条（ID: `cd9194ea-a580-458e-bc80-1e5b529a4c13`）
- 文件审查记录：3条（review_001, review_002, review_003）

---

## 📝 预置的测试数据

执行 `test_data.sql` 后，会为该用户创建以下测试数据：

| 数据类型 | 数量 | 说明 |
|---------|------|------|
| 文件审查记录 | 3条 | review_001, review_002, review_003 |
| 法律法规 | 5条 | reg_001 ~ reg_005 |
| 案例 | 3条 | case_001 ~ case_003 |
| 文书模板 | 5条 | template_001 ~ template_005 |
| 对话记录 | 3条 | conv_001 ~ conv_003 |
| 消息记录 | 18条 | 分布在3个对话中 |
| 收藏记录 | 3条 | fav_001 ~ fav_003 |
| 工具使用记录 | 4条 | tool_001 ~ tool_004 |
| 下载记录 | 3条 | dl_001 ~ dl_003 |
| 搜索历史 | 5条 | history_001 ~ history_005 |

---

## 🎯 测试流程示例

```
1. 登录 → POST /api/auth/login
   ↓
2. 获取Token（自动保存到环境变量）
   ↓
3. 获取历史列表 → GET /api/legal-tools/document-review/history
   （验证：应返回3条记录）
   ↓
4. 获取详情 → GET /api/legal-tools/document-review/review_001
   （验证：返回完整详情）
   ↓
5. 上传新文件 → POST /api/legal-tools/document-review
   （验证：返回审查结果）
   ↓
6. 再次获取历史列表 → GET /api/legal-tools/document-review/history
   （验证：应返回4条记录）
   ↓
7. 删除记录 → DELETE /api/legal-tools/document-review/review_003
   （验证：删除成功）
   ↓
8. 验证删除 → GET /api/legal-tools/document-review/history
   （验证：应返回3条记录，review_003已删除）
```

---

## ❓ 常见问题

### Q1: 登录失败，提示"用户不存在"或"密码错误"

**解决方案**：
1. 确认用户已存在：
   ```sql
   SELECT * FROM users WHERE id = 'cd9194ea-a580-458e-bc80-1e5b529a4c13';
   ```
2. 如果用户不存在，需要先注册或创建用户
3. 如果密码错误，可能需要重置密码或使用注册接口创建新用户

### Q2: 获取历史返回空数组

**解决方案**：
1. 确认测试数据已插入：
   ```sql
   SELECT * FROM document_reviews WHERE user_id = 'cd9194ea-a580-458e-bc80-1e5b529a4c13';
   ```
2. 如果数据不存在，执行测试数据脚本：
   ```bash
   mysql -u root -p123456 legal_assistant < src/main/resources/db/test_data.sql
   ```
3. 确认使用的 Token 对应的用户ID正确

### Q3: Token 无效或过期

**解决方案**：
1. Token 默认有效期为 24 小时
2. 如果 Token 过期，重新调用登录接口获取新 Token
3. 检查 Token 是否正确设置到环境变量中

---

## 📚 相关文档

- **完整测试指南**: [Apifox接口测试指南.md](Apifox接口测试指南.md)
- **快速开始**: [Apifox测试快速开始.md](Apifox测试快速开始.md)
- **API文档**: [../前端代码/API接口文档.md](../前端代码/API接口文档.md)

---

**最后更新**: 2024年  
**适用版本**: v1.0

