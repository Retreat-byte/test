<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>测试练习记录API</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        input {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>测试练习记录API</h1>
    
    <div class="test-section">
        <h3>1. 测试数据格式</h3>
        <p>测试前端发送的数据格式是否正确</p>
        <button onclick="testDataFormat()">测试数据格式</button>
        <div id="dataResult" class="result" style="display: none;"></div>
    </div>
    
    <div class="test-section">
        <h3>2. 测试API请求</h3>
        <p>测试实际的API请求（需要先登录）</p>
        <input type="text" id="phone" placeholder="手机号" value="13800138000">
        <input type="password" id="password" placeholder="密码" value="123456">
        <button onclick="loginAndTest()">登录并测试</button>
        <div id="apiResult" class="result" style="display: none;"></div>
    </div>
    
    <div class="test-section">
        <h3>3. 测试修复后的保存逻辑</h3>
        <p>测试修复后的练习记录保存逻辑</p>
        <button onclick="testFixedSave()">测试修复后的保存</button>
        <div id="fixResult" class="result" style="display: none;"></div>
    </div>

    <script>
        // 测试数据格式
        function testDataFormat() {
            const result = document.getElementById('dataResult');
            result.style.display = 'block';
            
            // 模拟修复后的数据
            const testData = {
                type: 'breathing',
                name: '正念呼吸',
                duration: Math.max(1, 0 * (4 + 6 + 2)), // 模拟cycleCount=0的情况
                description: '完成正念呼吸练习，持续1秒',
                tags: '正念,呼吸,放松'
            };
            
            result.innerHTML = `
                <h4>测试数据格式：</h4>
                <pre>${JSON.stringify(testData, null, 2)}</pre>
                <p><strong>duration:</strong> ${testData.duration} (应该 >= 1)</p>
                <p><strong>type:</strong> ${testData.type} (应该是 'breathing')</p>
                <p><strong>name:</strong> ${testData.name} (应该是 '正念呼吸')</p>
            `;
            result.className = 'result success';
        }
        
        // 登录并测试API
        async function loginAndTest() {
            const result = document.getElementById('apiResult');
            result.style.display = 'block';
            result.innerHTML = '正在登录...';
            result.className = 'result';
            
            try {
                const phone = document.getElementById('phone').value;
                const password = document.getElementById('password').value;
                
                // 1. 登录
                const loginResponse = await fetch('http://localhost:8081/api/users/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        phone: phone,
                        password: password
                    })
                });
                
                if (!loginResponse.ok) {
                    throw new Error(`登录失败: ${loginResponse.status}`);
                }
                
                const loginResult = await loginResponse.json();
                const token = loginResult.data.token;
                result.innerHTML += `<br>✅ 登录成功，token: ${token.substring(0, 20)}...`;
                
                // 2. 测试练习记录保存
                const practiceData = {
                    type: 'breathing',
                    name: '正念呼吸',
                    duration: 1, // 确保至少1秒
                    description: '完成正念呼吸练习，持续1秒',
                    tags: '正念,呼吸,放松'
                };
                
                result.innerHTML += `<br>正在测试练习记录保存...`;
                
                const practiceResponse = await fetch('http://localhost:8081/api/practices', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(practiceData)
                });
                
                if (practiceResponse.ok) {
                    const practiceResult = await practiceResponse.json();
                    result.innerHTML += `<br>✅ 练习记录保存成功！`;
                    result.innerHTML += `<br><pre>${JSON.stringify(practiceResult, null, 2)}</pre>`;
                    result.className = 'result success';
                } else {
                    const errorText = await practiceResponse.text();
                    result.innerHTML += `<br>❌ 练习记录保存失败: ${practiceResponse.status}`;
                    result.innerHTML += `<br>错误信息: ${errorText}`;
                    result.className = 'result error';
                }
                
            } catch (error) {
                result.innerHTML += `<br>❌ 测试失败: ${error.message}`;
                result.className = 'result error';
            }
        }
        
        // 测试修复后的保存逻辑
        function testFixedSave() {
            const result = document.getElementById('fixResult');
            result.style.display = 'block';
            
            // 模拟不同的cycleCount值
            const testCases = [
                { cycleCount: 0, inhaleTime: 4, exhaleTime: 6, expected: 1 },
                { cycleCount: 1, inhaleTime: 4, exhaleTime: 6, expected: 12 },
                { cycleCount: 3, inhaleTime: 4, exhaleTime: 6, expected: 36 }
            ];
            
            let html = '<h4>测试修复后的保存逻辑：</h4>';
            
            testCases.forEach((testCase, index) => {
                const totalDuration = Math.max(1, testCase.cycleCount * (testCase.inhaleTime + testCase.exhaleTime + 2));
                const isCorrect = totalDuration === testCase.expected;
                
                html += `
                    <div style="margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                        <strong>测试用例 ${index + 1}:</strong><br>
                        cycleCount: ${testCase.cycleCount}, inhaleTime: ${testCase.inhaleTime}, exhaleTime: ${testCase.exhaleTime}<br>
                        计算结果: ${totalDuration} (期望: ${testCase.expected})<br>
                        状态: ${isCorrect ? '✅ 正确' : '❌ 错误'}
                    </div>
                `;
            });
            
            result.innerHTML = html;
            result.className = 'result success';
        }
    </script>
</body>
</html>
